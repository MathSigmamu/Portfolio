YUI.add("tictac-att-slideshow",function(a){"use strict";function b(a){var c=this;b.superclass.constructor.apply(c,arguments),a.stats&&a.stats.stat&&(c.stats=a.stats),a.fetcher&&(c.fetcher=a.fetcher),c._timeoutObjects=[]}function c(b){var c=this;c.mouseTimeout=null,c.justHidden=!1,c.timeoutObj=null,this.start=function(){c.move(),c.justHidden=!1},this.clean=function(){this.stop(),this.timeoutObj&&this.timeoutObj.cancel()},this.stop=function(){c.mouseTimeout&&c.mouseTimeout.cancel(),c.mouseTimeout=null},this.move=function(d){var e;d&&"mousedown"===d.type&&d.target&&(e=a.one(".tictac-att-ss-docview-page-current input"),"INPUT"!==d.target.get("tagName")&&e&&e.blur()),c.justHidden||(c.justHidden=!1,c.mouseTimeout&&c.mouseTimeout.cancel(),b.onactive(),c.mouseTimeout=a.later(b.timeout,{},c.idled,[],!1))},this.idled=function(){b.onidle(),c.justHidden=!0,c.timeoutObj=a.later(500,{},function(){c.justHidden=!1},[],!1)}}var d,e,f=a.Tictac,g=f.base.isRTL,h=a.UA.ie<=9&&0!==a.UA.ie,i=10===a.UA.ie,j=a.Tictac.att.strings,k=a.Tictac.base.utils.transitionEndEventName();b.NAME="slideshow",b.ATTRS={attachments:{validator:a.Lang.isArray,value:null},position:{validator:a.Lang.isNumber,value:0},delay:{validator:a.Lang.isNumber,value:4e3},imgActive:{validator:a.Lang.isObject,value:{opacity:1}},imgInactive:{validator:a.Lang.isObject,value:{opacity:0}},duration:{validator:a.Lang.isNumber,value:.6},disableDownload:{validator:a.Lang.isBoolean,value:!1},easing:{validator:a.Lang.isString,value:"ease-in-out"},showDropboxLinK:{validator:a.Lang.isBoolean,value:!0}},a.extend(b,a.Widget,{renderUI:function(){var b=this,c=b.get("contentBox"),d=b.get("attachments");c.append(a.Tictac.att.rollups.slideshow_infinite({attachments:d,is_single:1===d.length,isRTL:g,isIE:h,disableDownload:b.get("disableDownload")})),b._slideshow=c.one(".tictac-att-slideshow"),b._spinner=a.one(".tictac-att-ss-topbar-scanning"),b._docviewToolbar=b._slideshow.one(".tictac-att-ss-docview-toolbar"),b._loadingSpinnerNode=b._slideshow.one(".tictac-att-ss-state-loading"),b._loadingSpinner=new a.comms.ui.Envelope(b._loadingSpinnerNode),b._errorNode=b._slideshow.one(".tictac-att-ss-state-error"),b._arrangeAttachments(),b.set("imageNodes",a.all(".tictac-att-ss-image")),b.set("documentNodes",a.all(".tictac-att-ss-doc")),b._hasRendered=!0},bindUI:function(){var b=this,c=b.get("contentBox"),d=a.Node.create('<div class="tictac-att-attachment-menu optionMenu"></div>');a.one("body").append(d),b._menuNodeSaveTo=d,b._events=[],b._events.push(c.one(".tictac-att-ss-footer").on("click",function(){var c=b.get("attachments"),d=b.get("position"),e=c[d],f=e.mid,g=e.fid;b.closeSlideshow(),a.Tictac.base.mailutils.openMessage({mid:f,fid:g})})),b._events.push(c.one(".tictac-att-ss-close").on("click",function(){b.closeSlideshow()})),b._events.push(c.one(".tictac-att-ss-controls-prev").on("click",function(){this.hasClass("att-ss-disabled")||(b.moveLeft(),b.stats.stat("slideshow_prev"))})),b._events.push(c.one(".tictac-att-ss-controls-next").on("click",function(){this.hasClass("att-ss-disabled")||(b.moveRight(),b.stats.stat("slideshow_next"))})),b._events.push(b._errorNode.one(".tictac-att-ss-state-error-retry").on("click",function(){b._loadAttachment(b.get("position"))})),b.get("disableDownload")||(b._events.push(c.delegate("click",b.hideError,".tictac-att-error-dismiss",b)),b._events.push(c.delegate("click",function(){var a=b.get("attachments"),c=b.get("position");b.fire("download:single",{data:a[c],pos:c}),b.stats.stat("slideshow_download_single")},".tictac-att-ss-topbar-download-single")),b._events.push(c.one(".tictac-att-ss-topbar-download").on("click",function(e){function f(){var e=a.Tictac.base.utils.getVal(a,"Tictac.dropbox.controller"),f=c.one(".tictac-att-ss-topbar-download");d.setHTML(a.Tictac.att.rollups.slideshowmenu({save_to_computer:!0,save_to_dropbox:!!e&&b.get("showDropboxLinK")})),a.common.ui.MenuHelper.create(f,{menu:d},function(){d.on("menuSelected",function(a){b.fire(a.dataAction,{data:b.get("attachments")[b.get("position")],pos:b.get("position"),callback:function(){b._setScanning(!1)}})})})}e.currentTarget.menu||(a.Tictac.base.utils.hasTictacModule("tictac-dropbox")?a.use("tictac-dropbox-controller",function(){f()}):f())}))),b._events.push(a.one(document.body).on("keydown",a.bind(function(a){var b=this,c=b.get("boundingBox");if(!c.hasClass("hidden"))switch(a.stopPropagation(),a.keyCode){case 37:g?b.moveRight():b.moveLeft();break;case 39:g?b.moveLeft():b.moveRight();break;case 27:return a.halt(),b.closeSlideshow(),!1}},b))),i||(b._events.push(c.on(["mousemove","mousedown","mousewheel","keypress"],b.mouseIdler.move)),b._events.push(c.delegate("hover",b.mouseIdler.stop,b.mouseIdler.start,".tictac-att-ss-controls")))},destructor:function(){var b=this,c=b.mouseIdler;c&&c.clean(),b._events&&a.each(b._events,function(a){a.detach()}),b._menuNodeSaveTo&&b._menuNodeSaveTo.remove(!0),b._timeoutObjects&&a.each(b._timeoutObjects,function(a){a.cancel()}),b.docManager&&b.docManager.cleanup(),b._loadingSpinner&&b._loadingSpinner.destroy(),b._dontListenForBackButton()},initializer:function(){var b=this,d=[],e=[],f=b.get("attachments");a.Array.each(f,function(a){"image"===a.type?d.push(a):e.push(a)}),b.set("attachments",d.concat(e));var g,h,i,j=function(){return a.one(".tictac-att-ss-active div")},k=function(){g=a.one(".tictac-att-slideshow-thumbs"),h=a.one(".tictac-att-ss-controls"),i=j()},l=function(a,b,c){var d=i&&i.ancestor()&&i.ancestor().hasClass("tictac-att-ss-active");g.setStyle("cursor",a),h.setStyle("display",b),i=d?i:j(),i&&i.setStyle("overflow",c)};b.mouseIdler=new c({onidle:function(){g||k(),this.onidle=function(){b.useMouseIdler()&&l("none","none","hidden")},this.onidle()},onactive:function(){g||k(),this.onactive=a.throttle(function(){l("auto","block","auto")},250),this.onactive()},timeout:3e3})},useMouseIdler:function(){return!0},_doListenForBackButton:function(){function a(){b._dontListenForBackButton(),b.hide()}var b=this;"function"==typeof window.history.pushState&&(b._doBackButton=a,window.history.pushState(null,""),window.addEventListener("popstate",b._doBackButton,!1))},_dontListenForBackButton:function(){var a=this;a._doBackButton&&(window.removeEventListener("popstate",a._doBackButton,!1),a._doBackButton=null)},_getAttachmentObject:function(a){var b=this.get("attachments"),c=null;return b&&b.get&&(c=b.get(a)),c},_arrangeAttachments:function(){var a,b=this,c=b.get("position"),d=b.get("imgActive"),e=b.get("attachments");b._slideshow.all(".tictac-att-ss-active").removeClass("tictac-att-ss-active"),a=e[c].aid,b._preload(c),b._slideshow.one('li[data-id="'+a+'"]').setStyles(d).addClass("tictac-att-ss-active"),b._uiUpdateStatus()},_transition:function(b){function c(){k&&this.removeEventListener(k,c),this===e.getDOMNode()&&e.removeClass(i),this===d.getDOMNode()&&d.addClass(i)}var d,e,f=this,g=f.get("attachments"),h=f.get("position"),i="tictac-att-ss-active";return b>=0&&b<g.length?(e=f._slideshow.one('li[data-id="'+g[h].aid+'"]'),d=f._slideshow.one('li[data-id="'+g[b].aid+'"]'),e&&(k&&e.getDOMNode().addEventListener(k,c),e.setStyle("opacity",f.get("imgInactive").opacity),k||window.setTimeout(a.bind(c,e.getDOMNode),0)),d&&(k&&d.getDOMNode().addEventListener(k,c),d.setStyle("opacity",f.get("imgActive").opacity),k||window.setTimeout(a.bind(c,d.getDOMNode),0)),f.set("position",b),!0):!1},_getAttSize:function(a){var b={};return a&&a.width&&a.height&&(b.maxWidth=a.width+"px",b.maxHeight=a.height+"px"),b},_setScanning:function(a){var b=this._slideshow;b&&(a?b.addClass("att-ss-scanning"):b.removeClass("att-ss-scanning"))},_move:function(a){var b=this,c=b.get("position"),d=!1;return"left"===a?d=b._transition(c-1):"right"===a&&(d=b._transition(c+1)),b._preload(b.get("position")),b._uiUpdateStatus(),d},_loadDoc:function(b,c,d){var e=this,g=a.one(".tictac-att-ss-docview-toolbar"),h=(new Date).getTime();a.use("tictac-att-docman",function(){e.docManager||(e.docManager=new f.att.DocManager({zoomIn:g.one(".tictac-att-ss-docview-zoom-in"),zoomOut:g.one(".tictac-att-ss-docview-zoom-out"),info:g.one(".tictac-att-ss-docview-page-current")},e._slideshow)),e.docManager.show(b,c,d,h)})},_loadAttachment:function(b,c){var d=this,e=d.get("attachments")[b],g=e.aid,h=d._slideshow.one('li[data-id="'+g+'"]'),i=d._slideshow.one(".tictac-att-ss-state-loading-message"),k={};e.hasLoaded||e.isLoading||e.isDoc&&c||(k={load:function(){e.hasLoaded=!0,e.hasError=!1,e.isLoading=!1,d._updateState(e,b),i.setStyle("display","none")},fail:function(a,c,g){e.hasLoaded=!1,e.hasError=!0,e.isLoading=!1,f.att.DocViewer&&g===f.att.DocViewer.PASSWORD_PROTECTED?a.isPasswordProtected=!0:f.att.DocViewer&&g===f.att.DocViewer.PREVIEW_SESSSION_EXPIRED&&(a.isPreviewSessionExpired=!0),d._updateState(e,b),i.setStyle("display","none")},beforeAttShow:function(c){e.isLoading=!0,d._timeoutObjects.push(a.later(300,d,function(){d._updateState(e,b),c===!0&&e.isLoading&&(i.setContent(j.str_generating_message),i.setStyle("display","inline"))},[],!1))}},e.isDoc?d._loadDoc(e,h,k):d._loadImage(e,h,k))},_updateState:function(a,b){var c,d=this;d.get("position")===b&&(a.isLoading?d._showSpinner():d._hideSpinner(),a.hasError&&!a.isLoading?(c=j.str_tictac_att_state_error,c=a.isPasswordProtected?j.str_tictac_att_password_error:c,c=a.isPreviewSessionExpired?j.str_tictac_att_preview_session_expired:c,d._showStateError(c,a.isPasswordProtected)):d._hideStateError(),a.isDoc&&a.hasLoaded?d._showDocToolbar():d._hideDocToolbar())},_showAttachment:function(a,b){var c=this;c._updateState(a,b),c.get("position")===b&&a.isDoc&&a.hasLoaded&&c.docManager.show(a)},_showDocToolbar:function(){this._docviewToolbar.show()},_hideDocToolbar:function(){this._docviewToolbar.hide()},_showSpinner:function(){var a=this._loadingSpinnerNode;a&&(a.show(),this._loadingSpinner.start())},_hideSpinner:function(){var a=this._loadingSpinnerNode;a&&(a.hide(),this._loadingSpinner.stop())},_showStateError:function(a,b){var c=this._errorNode,d=this._errorNode.one(".tictac-att-ss-state-error-retry");c.one(".tictac-att-ss-state-error-msg").set("text",a),c.show(),b?d.hide():d.show()},_hideStateError:function(){this._errorNode.hide()},_loadImage:function(a,b,c){function d(){c.load(),a.width=f.width,a.height=f.height,b.setStyles(g._getAttSize(a)),b.setStyle("backgroundImage","url("+a.fullsize+")")}function e(){c.fail()}var f,g=this;a.fullsize&&(c.beforeAttShow(),f=new Image,f.onload=d,f.onerror=e,f.src=a.fullsize)},_preload:function(b){var c,d=this,e=d.get("attachments"),f=2,g=2,h=b-f>0?b-f:0,i=b+g+1<e.length?b+g+1:e.length;for(d._loadAttachment(b),c=h;i>c;c++)c!==b&&d._loadAttachment(c,!0);i===e.length&&d.fetcher&&d.fetcher.hasMore()&&d.fetcher.fetch(function(b){var c;d.set("attachments",e.concat(b)),c=d._slideshow&&d._slideshow.one(".tictac-att-slideshow-thumbs"),c&&c.append(a.Tictac.att.rollups.slideshowattachment({attachments:b}))})},moveLeft:function(){return this._move("left")},moveRight:function(){return this._move("right")},show:function(a,b){var c,e,f=this,g=f.get("boundingBox"),h=a;if(g.one("#slideshow-scrollbar-style")||g.appendChild('<style id="slideshow-scrollbar-style">::-webkit-scrollbar-thumb { background: rgba(153, 153, 153, 0.75); }</style>'),b)for(c=f.get("attachments"),e=0;e<c.length;e++)if(c[e].aid===a){h=e;break}void 0!==a?(c=f.get("attachments"),f.set("position",h)):f.set("position",0),f.hasRendered()?f._arrangeAttachments():f.render(),g.removeClass("hidden"),f._doListenForBackButton(),window.yui&&(d=window.yui.mail.ui.Workspace.get("navKeys"),window.yui.mail.ui.Workspace.set("navKeys",null)),document.activeElement.blur()},closeSlideshow:function(){var b,c=this;c.docManager&&(b=c.docManager.viewers,a.each(b,function(a){c.docManager.stat("docview_ss_close",{count:a.countPagesSeen()})})),c._slideshow.all("li[data-id]").setStyle("opacity",""),c.hide()},hide:function(){var a=this,b=this.get("boundingBox"),c=b.one("#slideshow-scrollbar-style");b.addClass("hidden"),c&&c.remove&&c.remove(!0),a.mouseIdler&&a.mouseIdler.stop(),a._hideSpinner(),a.fire("hide"),!NeoConfig.backButtonFull&&a._doBackButton&&window.history.back(),a._dontListenForBackButton(),window.yui&&window.yui.mail.ui.Workspace.set("navKeys",d)},hasRendered:function(){return!!this._hasRendered},_uiUpdateStatus:function(){var b,c,d,e,f=this,g=f._slideshow.one,h=g(".tictac-att-ss-controls-prev"),i=g(".tictac-att-ss-controls-next"),j=g(".tictac-att-ss-topbar-filename"),k=g(".tictac-att-ss-footer"),l=g(".tictac-att-ss-photo"),m=g(".tictac-att-ss-from >p"),n=g(".tictac-att-ss-folderdate >p"),o=g(".tictac-att-ss-snippet >p"),p=g(".tictac-att-ss-subject >p");f._uiUpdateStatus=function(){b=f.get("position"),d=f.get("attachments"),c=d[b],f._showAttachment(c,b),j.setHTML(a.Escape.html(d[b].filename)),c.imageUrl?(l.setStyle("backgroundImage",'url("'+c.imageUrl+'")'),m.setHTML(a.Escape.html(c.fromStr)),e=c.folderStr||yui.mail.ui.common.StringUtils.getSystemFolderName(c.fid,c.fid),c.folderDate=e+" "+c.dateStr,n.setHTML(a.Escape.html(c.folderDate)),o.setHTML(a.Escape.html(c.snippet)),p.setHTML(a.Escape.html(c.subject)),g("ul.tictac-att-slideshow-thumbs").addClass("tictac-att-slideshow-has-footer"),k.removeClass("hidden")):k.addClass("hidden"),0===b?h.addClass("att-ss-disabled"):h.removeClass("att-ss-disabled"),b+1>=d.length?i.addClass("att-ss-disabled"):i.removeClass("att-ss-disabled")},f._uiUpdateStatus()},_getErrorNode:function(){return this._slideshow.one(".tictac-att-ss-topbar-error")},_showError:function(a){a?this._slideshow.addClass("att-ss-error"):this._slideshow.removeClass("att-ss-error")},_startSpinning:function(){this._setScanning(!0)},_stopSpinning:function(){this._setScanning(!1)},_getArray:function(){return e?e.getArray(null,!0):this._getCollection().getArray(null,!0)},_getCollection:function(){var b=this.get("attachments");return e&&e.getViewableArray().length>0&&e.getViewableArray().length===b.length&&b[0].aid===e.getViewableArray()[0].aid?e:(e=new a.Tictac.att.Collection,a.Array.each(b,function(b){e.add(new a.Tictac.att.Attachment(b))}),e)}}),a.mix(b.prototype,a.Tictac.att.AttachmentView),a.namespace("Tictac.att").Slideshow=b},"1.0.0",{requires:["array-extras","event-hover","event-mousewheel","node-base","widget","comms-ui-envelope","common-ui-menu-helper","tictac-att-attachments","tictac-att-attachmentview","tictac-att-rollups","tictac-att-strings","tictac-base","tictac-base-stats","tictac-base-utils","tictac-base-mailutils","yui-throttle","event-custom","escape"]});YUI.add("tictac-atm-strings",function(a){a.namespace("Tictac.atm").strings={str_view_attachments:"This message has attachments",str_view_attachment:"This message has an attachment",last:null}},"1.0.0");